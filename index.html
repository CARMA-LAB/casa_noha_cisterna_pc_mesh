<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="description" content="CASA NOHA – Cisterna">
  <meta name="author" content="ARCANGELO PRIORE">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Potree Viewer – CASA NOHA</title>

  <link rel="stylesheet" type="text/css" href="./build/potree/potree.css">
  <link rel="stylesheet" type="text/css" href="./libs/jquery-ui/jquery-ui.min.css">
  <link rel="stylesheet" type="text/css" href="./libs/openlayers3/ol.css">
  <link rel="stylesheet" type="text/css" href="./libs/spectrum/spectrum.css">
  <link rel="stylesheet" type="text/css" href="./libs/jstree/themes/mixed/style.css">
</head>

<body>

<!-- LIBS -->
<script src="./libs/jquery/jquery-3.1.1.min.js"></script>
<script src="./libs/spectrum/spectrum.js"></script>
<script src="./libs/jquery-ui/jquery-ui.min.js"></script>
<script src="./libs/other/BinaryHeap.js"></script>
<script src="./libs/tween/tween.min.js"></script>
<script src="./libs/d3/d3.js"></script>
<script src="./libs/proj4/proj4.js"></script>
<script src="./libs/openlayers3/ol.js"></script>
<script src="./libs/i18next/i18next.js"></script>
<script src="./libs/jstree/jstree.js"></script>
<script src="./build/potree/potree.js"></script>
<script src="./libs/plasio/js/laslaz.js"></script>

<!-- CONTAINER -->
<div class="potree_container" style="position:absolute; width:100%; height:100%; left:0; top:0;">
  <div id="potree_render_area"
       style="background-image:url('./build/potree/resources/images/NUOVO_LOGO_FAI.jpg');">
  </div>
  <div id="potree_sidebar_container"></div>
</div>

<!-- ================= SCRIPT MODULE (come esempio ufficiale) ================= -->
<script type="module">
  import * as THREE from "./libs/three.js/build/three.module.js";
  import { OBJLoader } from "./libs/three.js/loaders/OBJLoader.js";
  // alternativa se la tua build usa jsm:
  // import { OBJLoader } from "./libs/three.js/examples/jsm/loaders/OBJLoader.js";

  /* =====================================================
     VIEWER
  ===================================================== */
  window.viewer = new Potree.Viewer(
    document.getElementById("potree_render_area")
  );

  viewer.setEDLEnabled(true);
  viewer.setFOV(60);
  viewer.setPointBudget(2_000_000);
  viewer.loadSettingsFromURL();

  viewer.setDescription("CASA NOHA – Cisterna");

  viewer.loadGUI(() => {
    viewer.setLanguage("en");
    $("#menu_scene").next().show();
    $("#menu_appearance").next().show();
  });

  /* =====================================================
     LIGHTS (default, non trasformative)
  ===================================================== */
  {
    const directional = new THREE.DirectionalLight(0xffffff, 1.0);
    directional.position.set(10, 10, 10);

    const ambient = new THREE.AmbientLight(0x777777);

    viewer.scene.scene.add(directional);
    viewer.scene.scene.add(ambient);
  }

  /* =====================================================
     POINT CLOUD
  ===================================================== */
  Potree.loadPointCloud(
    "./pointclouds/metadata.json",
    "Cisterna – Point Cloud",
    (e) => {
      const pc = e.pointcloud;

      viewer.scene.addPointCloud(pc);

      pc.material.activeAttributeName = "rgba";
      pc.material.pointSizeType = Potree.PointSizeType.FIXED;
      pc.material.size = 2.0;
      pc.material.minSize = 2;

      viewer.fitToScreen();

      // carica mesh dopo la nuvola
      loadOBJ();
    }
  );

  /* =====================================================
     OBJ MESH – DEFAULT ASSOLUTO
     (nessuna traslazione, scala, rotazione)
  ===================================================== */
  function loadOBJ() {
    const loader = new OBJLoader();

    loader.load(
      "./mesh/cisterna.obj",
      (object) => {

        // NON tocchiamo position / rotation / scale
        // object.position, rotation, scale rimangono quelle dell’OBJ

        // preserva materiali (se presenti), forza solo DoubleSide
        object.traverse((child) => {
          if (child.isMesh && child.material) {
            const mats = Array.isArray(child.material)
              ? child.material
              : [child.material];
            mats.forEach(m => {
              m.side = THREE.DoubleSide;
              m.needsUpdate = true;
            });
          }
        });

        viewer.scene.scene.add(object);

        // toggle nella scena (come esempio ufficiale)
        viewer.onGUILoaded(() => {
          const tree = $("#jstree_scene");
          const parentNode = "other";

          const id = tree.jstree("
