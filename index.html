<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="description" content="CASA NOHA – Cisterna">
  <meta name="author" content="ARCANGELO PRIORE">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Potree Viewer – CASA NOHA</title>

  <link rel="stylesheet" type="text/css" href="./build/potree/potree.css">
  <link rel="stylesheet" type="text/css" href="./libs/jquery-ui/jquery-ui.min.css">
  <link rel="stylesheet" type="text/css" href="./libs/openlayers3/ol.css">
  <link rel="stylesheet" type="text/css" href="./libs/spectrum/spectrum.css">
  <link rel="stylesheet" type="text/css" href="./libs/jstree/themes/mixed/style.css">
</head>

<body>
  <!-- LIBS -->
  <script src="./libs/jquery/jquery-3.1.1.min.js"></script>
  <script src="./libs/spectrum/spectrum.js"></script>
  <script src="./libs/jquery-ui/jquery-ui.min.js"></script>
  <script src="./libs/other/BinaryHeap.js"></script>
  <script src="./libs/tween/tween.min.js"></script>
  <script src="./libs/d3/d3.js"></script>
  <script src="./libs/proj4/proj4.js"></script>
  <script src="./libs/openlayers3/ol.js"></script>
  <script src="./libs/i18next/i18next.js"></script>
  <script src="./libs/jstree/jstree.js"></script>
  <script src="./build/potree/potree.js"></script>
  <script src="./libs/plasio/js/laslaz.js"></script>

  <!-- CONTAINER -->
  <div class="potree_container" style="position:absolute; width:100%; height:100%; left:0; top:0;">
    <div id="potree_render_area"
         style="background-image:url('./build/potree/resources/images/NUOVO_LOGO_FAI.jpg');">
    </div>
    <div id="potree_sidebar_container"></div>
  </div>

  <!-- MODULE SCRIPT (come esempio) -->
  <script type="module">
    import * as THREE from "./libs/three.js/build/three.module.js";
    import { OBJLoader } from "./libs/three.js/loaders/OBJLoader.js";
    // alternativa se serve:
    // import { OBJLoader } from "./libs/three.js/examples/jsm/loaders/OBJLoader.js";

    const POINTCLOUD_PATH = "./pointclouds/metadata.json";
    const OBJ_PATH        = "./mesh/cisterna.obj";

    // Viewer
    window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));
    viewer.setEDLEnabled(true);
    viewer.setFOV(60);
    viewer.setPointBudget(2_000_000);
    viewer.loadSettingsFromURL();
    viewer.setDescription("CASA NOHA – Cisterna (Point Cloud + OBJ)");

    viewer.loadGUI(() => {
      viewer.setLanguage("en");
      $("#menu_scene").next().show();
      $("#menu_appearance").next().show();
    });

    // Lights (non alterano coordinate)
    {
      const directional = new THREE.DirectionalLight(0xffffff, 1.0);
      directional.position.set(10, 10, 10);
      directional.lookAt(0, 0, 0);

      const ambient = new THREE.AmbientLight(0x777777);

      viewer.scene.scene.add(directional);
      viewer.scene.scene.add(ambient);
    }

    // Point cloud
    Potree.loadPointCloud(POINTCLOUD_PATH, "Cisterna – Point Cloud", (e) => {
      const pc = e.pointcloud;
      viewer.scene.addPointCloud(pc);

      pc.material.activeAttributeName = "rgba";
      pc.material.pointSizeType = Potree.PointSizeType.FIXED;
      pc.material.size = 2.0;
      pc.material.minSize = 2;

      viewer.fitToScreen();

      // carica mesh dopo
      loadOBJ();
    });

    // Mesh OBJ (nessuna trasformazione)
    let objMesh = null;

    function keepMaterialsButDoubleSide(obj) {
      obj.traverse((child) => {
        if (child.isMesh && child.material) {
          const mats = Array.isArray(child.material) ? child.material : [child.material];
          for (const m of mats) {
            m.side = THREE.DoubleSide;
            m.needsUpdate = true;
          }
        }
      });
    }

    function registerInSceneTree(label, object3D) {
      viewer.onGUILoaded(() => {
        const tree = $("#jstree_scene");
        const parentNode = "other";

        const id = tree.jstree("create_node", parentNode, {
          text: label,
          icon: `${Potree.resourcePath}/icons/triangle.svg`,
          data: object3D
        }, "last", false, false);

        tree.jstree(object3D.visible ? "check_node" : "uncheck_node", id);
      });
    }

    function loadOBJ() {
      const loader = new OBJLoader();

      loader.load(
        OBJ_PATH,
        (object) => {
          objMesh = object;

          // ✅ nessuna traslazione/rotazione/scala
          // object.position/rotation/scale lasciati come sono

          // preserva eventuali materiali (non sostituisce texture)
          keepMaterialsButDoubleSide(objMesh);

          // visibile (puoi metterlo false se vuoi toggle)
          objMesh.visible = true;

          viewer.scene.scene.add(objMesh);
          registerInSceneTree("Cisterna – Mesh OBJ", objMesh);

          console.log("OBJ loaded (no transforms applied):", objMesh);
        },
        undefined,
        (err) => console.error("Errore caricamento OBJ:", err)
      );
    }
  </script>
</body>
</html>
