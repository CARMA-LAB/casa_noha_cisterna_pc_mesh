<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="description" content="CASA NOHA – Cisterna">
  <meta name="author" content="ARCANGELO PRIORE">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Potree Viewer – CASA NOHA (OBJ)</title>

  <link rel="stylesheet" type="text/css" href="./build/potree/potree.css">
  <link rel="stylesheet" type="text/css" href="./libs/jquery-ui/jquery-ui.min.css">
  <link rel="stylesheet" type="text/css" href="./libs/openlayers3/ol.css">
  <link rel="stylesheet" type="text/css" href="./libs/spectrum/spectrum.css">
  <link rel="stylesheet" type="text/css" href="./libs/jstree/themes/mixed/style.css">
</head>

<body>
  <!-- LIBS -->
  <script src="./libs/jquery/jquery-3.1.1.min.js"></script>
  <script src="./libs/spectrum/spectrum.js"></script>
  <script src="./libs/jquery-ui/jquery-ui.min.js"></script>
  <script src="./libs/other/BinaryHeap.js"></script>
  <script src="./libs/tween/tween.min.js"></script>
  <script src="./libs/d3/d3.js"></script>
  <script src="./libs/proj4/proj4.js"></script>
  <script src="./libs/openlayers3/ol.js"></script>
  <script src="./libs/i18next/i18next.js"></script>
  <script src="./libs/jstree/jstree.js"></script>
  <script src="./build/potree/potree.js"></script>
  <script src="./libs/plasio/js/laslaz.js"></script>

  <!-- CONTAINER -->
  <div class="potree_container" style="position:absolute; width:100%; height:100%; left:0; top:0;">
    <div id="potree_render_area"
         style="background-image:url('./build/potree/resources/images/NUOVO_LOGO_FAI.jpg');">
    </div>
    <div id="potree_sidebar_container"></div>
  </div>

  <!-- ✅ MODULE SCRIPT (come l'esempio) -->
  <script type="module">
    import * as THREE from "./libs/three.js/build/three.module.js";
    import { OBJLoader } from "./libs/three.js/loaders/OBJLoader.js";
    // Se non esiste questa path, prova:
    // import { OBJLoader } from "./libs/three.js/examples/jsm/loaders/OBJLoader.js";

    // -----------------------------
    // CONFIG
    // -----------------------------
    const POINTCLOUD_PATH = "./pointclouds/metadata.json";
    const OBJ_PATH = "./mesh/cisterna.obj";

    // Mesh: OFF di default (come richiesto)
    const MESH_DEFAULT_VISIBLE = false;

    // Parametri di fino (se non la vedi subito)
    const MESH_SCALE  = 1.0;                                // prova 0.001 o 1000
    const MESH_ROT    = new THREE.Euler(0, 0, 0);            // es. new THREE.Euler(-Math.PI/2, 0, 0)
    const MESH_OFFSET = new THREE.Vector3(0, 0, 0);          // offset manuale

    // -----------------------------
    // VIEWER
    // -----------------------------
    window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));

    viewer.setEDLEnabled(true);
    viewer.setFOV(60);
    viewer.setPointBudget(2_000_000);
    viewer.loadSettingsFromURL();

    viewer.setDescription("CASA NOHA – Cisterna (Point Cloud + OBJ mesh)");

    viewer.loadGUI(() => {
      viewer.setLanguage("en");
      $("#menu_scene").next().show();       // per vedere jstree_scene
      $("#menu_appearance").next().show();
      // viewer.toggleSidebar();
    });

    // -----------------------------
    // LIGHTS (come esempio)
    // -----------------------------
    {
      const directional = new THREE.DirectionalLight(0xffffff, 1.0);
      directional.position.set(10, 10, 10);
      directional.lookAt(0, 0, 0);

      const ambient = new THREE.AmbientLight(0x777777);

      viewer.scene.scene.add(directional);
      viewer.scene.scene.add(ambient);
    }

    // -----------------------------
    // POINT CLOUD
    // -----------------------------
    let pcRef = null;

    Potree.loadPointCloud(POINTCLOUD_PATH, "Cisterna – Point Cloud", (e) => {
      pcRef = e.pointcloud;

      viewer.scene.addPointCloud(pcRef);

      // Settaggi visuali (adatta a ciò che già usavi)
      pcRef.material.activeAttributeName = "rgba";
      pcRef.material.pointSizeType = Potree.PointSizeType.FIXED;
      pcRef.material.size = 2.0;
      pcRef.material.minSize = 2;

      viewer.fitToScreen();

      // Mesh dopo la point cloud
      loadOBJ();
    });

    // -----------------------------
    // OBJ MESH + Registrazione nella sidebar (jstree_scene)
    // -----------------------------
    let objMesh = null;

    function applyTransform(obj) {
      obj.scale.setScalar(MESH_SCALE);
      obj.rotation.copy(MESH_ROT);
      obj.position.add(MESH_OFFSET);
    }

    // Allineamento “safe”: centra la mesh sulla bounding box della point cloud
    function autoAlignToPointCloud(pc, obj) {
      if (!pc) return;

      pc.updateMatrixWorld(true);
      const pcBox = pc.boundingBox.clone().applyMatrix4(pc.matrixWorld);
      const pcCenter = pcBox.getCenter(new THREE.Vector3());

      obj.updateMatrixWorld(true);
      const objBox = new THREE.Box3().setFromObject(obj);
      const objCenter = objBox.getCenter(new THREE.Vector3());

      obj.position.add(pcCenter.sub(objCenter));
    }

    function forceSafeMaterial(obj) {
      // materiale “safe” (se OBJ non ha materiali, o li ha ma non sono web-friendly)
      obj.traverse((child) => {
        if (child.isMesh) {
          child.material = new THREE.MeshStandardMaterial({
            color: 0xcccccc,
            roughness: 1.0,
            metalness: 0.0,
            side: THREE.DoubleSide
          });
        }
      });
    }

    function registerInSceneTree(label, object3D) {
      viewer.onGUILoaded(() => {
        const tree = $(`#jstree_scene`);
        const parentNode = "other";

        const id = tree.jstree('create_node', parentNode, {
          text: label,
          icon: `${Potree.resourcePath}/icons/triangle.svg`,
          data: object3D
        }, "last", false, false);

        tree.jstree(object3D.visible ? "check_node" : "uncheck_node", id);
      });
    }

    function loadOBJ() {
      const loader = new OBJLoader();

      loader.load(
        OBJ_PATH,
        (object) => {
          objMesh = object;
          objMesh.visible = MESH_DEFAULT_VISIBLE;

          forceSafeMaterial(objMesh);
          applyTransform(objMesh);
          autoAlignToPointCloud(pcRef, objMesh);

          viewer.scene.scene.add(objMesh);
          registerInSceneTree("Cisterna – Mesh OBJ", objMesh);

          console.log("OBJ loaded:", objMesh);
        },
        (xhr) => {
          if (xhr.lengthComputable) {
            const pct = (xhr.loaded / xhr.total) * 100;
            console.log(`OBJ: ${pct.toFixed(1)}%`);
          }
        },
        (err) => console.error("Errore caricamento OBJ:", err)
      );
    }
  </script>
</body>
</html>