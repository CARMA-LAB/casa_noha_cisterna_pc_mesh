<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="description" content="CASA NOHA – Cisterna">
  <meta name="author" content="ARCANGELO PRIORE">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Potree Viewer – CASA NOHA</title>

  <link rel="stylesheet" href="./build/potree/potree.css">
  <link rel="stylesheet" href="./libs/jquery-ui/jquery-ui.min.css">
  <link rel="stylesheet" href="./libs/openlayers3/ol.css">
  <link rel="stylesheet" href="./libs/spectrum/spectrum.css">
  <link rel="stylesheet" href="./libs/jstree/themes/mixed/style.css">
</head>

<body>

<!-- LIBS -->
<script src="./libs/jquery/jquery-3.1.1.min.js"></script>
<script src="./libs/spectrum/spectrum.js"></script>
<script src="./libs/jquery-ui/jquery-ui.min.js"></script>
<script src="./libs/other/BinaryHeap.js"></script>
<script src="./libs/tween/tween.min.js"></script>
<script src="./libs/d3/d3.js"></script>
<script src="./libs/proj4/proj4.js"></script>
<script src="./libs/openlayers3/ol.js"></script>
<script src="./libs/i18next/i18next.js"></script>
<script src="./libs/jstree/jstree.js"></script>
<script src="./build/potree/potree.js"></script>
<script src="./libs/plasio/js/laslaz.js"></script>

<!-- CONTAINER -->
<div class="potree_container" style="position:absolute; width:100%; height:100%; left:0; top:0;">
  <div id="potree_render_area"
       style="background-image:url('./build/potree/resources/images/NUOVO_LOGO_FAI.jpg');">
  </div>
  <div id="potree_sidebar_container"></div>
</div>

<!-- ================= MODULE SCRIPT (come esempio) ================= -->
<script type="module">
  import * as THREE from "./libs/three.js/build/three.module.js";
  import { OBJLoader } from "./libs/three.js/loaders/OBJLoader.js";
  // se necessario:
  // import { OBJLoader } from "./libs/three.js/examples/jsm/loaders/OBJLoader.js";

  /* =====================================================
     CONFIG
  ===================================================== */
  const POINTCLOUD_PATH = "./pointclouds/metadata.json";
  const OBJ_PATH        = "./mesh/cisterna.obj";

  const MESH_VISIBLE_DEFAULT = false;

  //  Trasformazioni volutamente neutre
  const MESH_SCALE  = 1.0;
  const MESH_ROT    = new THREE.Euler(0, 0, 0);
  const MESH_OFFSET = new THREE.Vector3(0, 0, 0);

  /* =====================================================
     VIEWER
  ===================================================== */
  window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));

  viewer.setEDLEnabled(true);
  viewer.setFOV(60);
  viewer.setPointBudget(2_000_000);
  viewer.loadSettingsFromURL();

  viewer.setDescription("CASA NOHA – Cisterna (Point Cloud + Mesh)");

  viewer.loadGUI(() => {
    viewer.setLanguage("en");
    $("#menu_scene").next().show();       // fondamentale per vedere il toggle mesh
    $("#menu_appearance").next().show();
  });

  /* =====================================================
     LIGHTS (necessarie per mesh)
  ===================================================== */
  {
    const dir = new THREE.DirectionalLight(0xffffff, 1.0);
    dir.position.set(10, 10, 10);
    viewer.scene.scene.add(dir);

    const amb = new THREE.AmbientLight(0x777777);
    viewer.scene.scene.add(amb);
  }

  /* =====================================================
     POINT CLOUD
  ===================================================== */
  let pcOffset = new THREE.Vector3(0, 0, 0);

  Potree.loadPointCloud(POINTCLOUD_PATH, "Cisterna – Point Cloud", (e) => {
    const pc = e.pointcloud;

    viewer.scene.addPointCloud(pc);

    pc.material.activeAttributeName = "rgba";
    pc.material.pointSizeType = Potree.PointSizeType.FIXED;
    pc.material.size = 2.0;
    pc.material.minSize = 2;

    //  OFFSET POTREE (causa del disallineamento)
    if (pc.pcoGeometry && pc.pcoGeometry.offset) {
      pcOffset = pc.pcoGeometry.offset.clone();
      console.log("Potree offset:", pcOffset);
    }

    viewer.fitToScreen();

    loadOBJ();   // mesh dopo la point cloud
  });

  /* =====================================================
     OBJ MESH
  ===================================================== */
  let objMesh = null;

  function applyTransform(obj) {
    obj.scale.setScalar(MESH_SCALE);
    obj.rotation.copy(MESH_ROT);
    obj.position.add(MESH_OFFSET);
  }

  //  NON sostituisce materiali → non perdi texture
  function keepMaterials(obj) {
    obj.traverse((c) => {
      if (c.isMesh && c.material) {
        const mats = Array.isArray(c.material) ? c.material : [c.material];
        mats.forEach(m => {
          m.side = THREE.DoubleSide;
          m.needsUpdate = true;
        });
      }
    });
  }

  function registerInSceneTree(label, object3D) {
    viewer.onGUILoaded(() => {
      const tree = $("#jstree_scene");
      const parentNode = "other";

      const id = tree.jstree("create_node", parentNode, {
        text: label,
        icon: `${Potree.resourcePath}/icons/triangle.svg`,
        data: object3D
      }, "last", false, false);

      tree.jstree(object3D.visible ? "check_node" : "uncheck_node", id);
    });
  }

  function loadOBJ() {
    const loader = new OBJLoader();

    loader.load(
      OBJ_PATH,
      (object) => {
        objMesh = object;
        objMesh.visible = MESH_VISIBLE_DEFAULT;

        keepMaterials(objMesh);
        applyTransform(objMesh);

        // ALLINEAMENTO CORRETTO:
        // la mesh viene portata nello stesso sistema locale della point cloud
        objMesh.position.sub(pcOffset);

        viewer.scene.scene.add(objMesh);
        registerInSceneTree("Cisterna – Mesh OBJ", objMesh);

        console.log("OBJ loaded correctly (offset applied)");
      },
      undefined,
      (err) => console.error("Errore caricamento OBJ:", err)
    );
  }
</script>

</body>
</html>
